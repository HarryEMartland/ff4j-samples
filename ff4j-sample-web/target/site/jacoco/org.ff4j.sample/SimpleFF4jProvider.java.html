<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SimpleFF4jProvider.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ff4j-sample-web</a> &gt; <a href="index.source.html" class="el_package">org.ff4j.sample</a> &gt; <span class="el_source">SimpleFF4jProvider.java</span></div><h1>SimpleFF4jProvider.java</h1><pre class="source lang-java linenums">package org.ff4j.sample;

import static org.ff4j.audit.EventConstants.ACTION_CHECK_OK;
import static org.ff4j.audit.EventConstants.SOURCE_JAVA;
import static org.ff4j.audit.EventConstants.TARGET_FEATURE;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/*
 * #%L
 * ff4j-sample-web
 * %%
 * Copyright (C) 2013 - 2016 FF4J
 * %%
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * #L%
 */


import org.ff4j.FF4j;
import org.ff4j.audit.Event;
import org.ff4j.audit.EventConstants;
import org.ff4j.audit.repository.EventRepository;
import org.ff4j.core.Feature;
import org.ff4j.utils.TimeUtils;
import org.ff4j.utils.Util;
import org.ff4j.web.FF4jProvider;

public class SimpleFF4jProvider implements FF4jProvider {

    /** ff4j instance. */
    private final FF4j ff4j;
    
<span class="fc" id="L46">    private List &lt; String &gt; sources = new ArrayList&lt;String&gt;();</span>
    
<span class="fc" id="L48">    private List &lt; String &gt; hostNames = new ArrayList&lt;String&gt;();</span>
    
<span class="fc" id="L50">    private List &lt; String &gt; users = new ArrayList&lt;String&gt;();</span>
    
    
    // Utility to generate event
    protected Event generateFeatureUsageEvent(String uid) {
<span class="fc" id="L55">        Event evt = new Event(SOURCE_JAVA, TARGET_FEATURE, uid, ACTION_CHECK_OK);</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (System.currentTimeMillis() % 2 == 0) {</span>
<span class="fc" id="L57">            evt.setHostName(Util.getRandomElement(hostNames));</span>
<span class="fc" id="L58">            evt.setSource(Util.getRandomElement(sources));</span>
<span class="fc" id="L59">            evt.setUser( Util.getRandomElement(users));</span>
        }
<span class="fc" id="L61">        return evt;</span>
    }
    
    // Generate a random event during the period
    protected Event generateFeatureUsageEvent(String uid, long timestamp) {
<span class="fc" id="L66">        Event event = generateFeatureUsageEvent(uid);</span>
<span class="fc" id="L67">        event.setTimestamp(timestamp);</span>
<span class="fc" id="L68">        return event;</span>
    }
    
    // Generate a random event during the period
    protected Event generateFeatureUsageEvent(String uid, long from, long to) {
<span class="fc" id="L73">        return generateFeatureUsageEvent(uid, from + (long) (Math.random() * (to-from)));</span>
    }
    
    // Generate a random event during the period
    protected Event generateRandomFeatureUsageEvent(List &lt; Feature &gt; features, long from, long to) {
<span class="fc" id="L78">        return generateFeatureUsageEvent(Util.getRandomElement(features).getUid(), from , to);</span>
    }
    
    // Populate repository for test
    public void populateRepository(int totalEvent) {
<span class="fc" id="L83">        EventRepository repo      = getFF4j().getEventRepository(); </span>
        
<span class="fc" id="L85">        List &lt; Feature &gt; features = new ArrayList&lt;Feature&gt;(getFF4j().getFeatures().values());</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">        for (int i = 0; i &lt; totalEvent; i++) {</span>
<span class="fc" id="L87">            repo.saveEvent(generateRandomFeatureUsageEvent(features,</span>
<span class="fc" id="L88">                    TimeUtils.getTodayMidnightTime(), </span>
<span class="fc" id="L89">                    TimeUtils.getTomorrowMidnightTime()));</span>
        }

<span class="fc" id="L92">        List &lt; String &gt;  actions  = new ArrayList&lt;String&gt;(Arrays.asList(EventConstants.ACTION_CREATE, </span>
                EventConstants.ACTION_CREATE, EventConstants.ACTION_DELETE, EventConstants.ACTION_CONNECT));
        // Events for audit trail today
<span class="fc bfc" id="L95" title="All 2 branches covered.">        for (int j = 0; j &lt; 9; j++) {</span>
<span class="fc" id="L96">            Event evt = generateRandomFeatureUsageEvent(features,</span>
<span class="fc" id="L97">                    TimeUtils.getTodayMidnightTime(), </span>
<span class="fc" id="L98">                    TimeUtils.getTomorrowMidnightTime());</span>
<span class="fc" id="L99">            evt.setAction(Util.getRandomElement(actions));</span>
<span class="fc" id="L100">            repo.saveEvent(evt);</span>
        }
        // Events for audit trail 100 days
<span class="fc bfc" id="L103" title="All 2 branches covered.">        for (int k = 0; k &lt; 100; k++) {</span>
<span class="fc" id="L104">            Event evt = generateRandomFeatureUsageEvent(features,</span>
<span class="fc" id="L105">                    TimeUtils.getTodayMidnightTime() - (1000 * 3600) * 24 * 100 * k, </span>
<span class="fc" id="L106">                    TimeUtils.getTodayMidnightTime());</span>
<span class="fc" id="L107">            evt.setAction(Util.getRandomElement(actions));</span>
<span class="fc" id="L108">            repo.saveEvent(evt);</span>
        }
        
<span class="fc" id="L111">    }</span>

    /**
     * Default constructeur invoked by servlet.
     */
<span class="fc" id="L116">    public SimpleFF4jProvider() {</span>
<span class="fc" id="L117">        ff4j = new FF4j(&quot;ff4j.xml&quot;).audit(true);</span>
        
<span class="fc" id="L119">        sources.add(SOURCE_JAVA);</span>
<span class="fc" id="L120">        sources.add(EventConstants.SOURCE_SSH);</span>
<span class="fc" id="L121">        sources.add(EventConstants.SOURCE_WEB);</span>
<span class="fc" id="L122">        sources.add(EventConstants.SOURCE_WEBAPI);</span>
        
<span class="fc" id="L124">        hostNames.add(&quot;node1&quot;);</span>
<span class="fc" id="L125">        hostNames.add(&quot;node2&quot;);</span>
        
<span class="fc" id="L127">        users.add(&quot;Pierre&quot;);</span>
<span class="fc" id="L128">        users.add(&quot;Paul&quot;);</span>
<span class="fc" id="L129">        users.add(&quot;Jacques&quot;);</span>
        
        // Create random DATA for today
<span class="fc" id="L132">        populateRepository(100);</span>
<span class="fc" id="L133">    }</span>

    /**
     * Getter accessor for attribute 'fF4j'.
     *
     * @return current value of 'fF4j'
     */
    @Override
    public FF4j getFF4j() {
<span class="fc" id="L142">        return ff4j;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>